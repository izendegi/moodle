{"version":3,"file":"popup.min.js","sources":["../src/popup.js"],"sourcesContent":["// This file is part of MuTMS suite of plugins for Moodleâ„¢ LMS.\n//\n// This program is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// This program is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with this program.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * Shows log-in-as dialog with instructions to right clock to open a new Incognito Window.\n *\n * @module      tool_muloginas/popup\n * @copyright   2025 Petr Skoda\n * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport ModalEvents from 'core/modal_events';\nimport CancelModal from 'core/modal_cancel';\nimport Notification from 'core/notification';\nimport Ajax from 'core/ajax';\nimport * as Str from 'core/str';\nimport Templates from 'core/templates';\n\n/* eslint-disable promise/no-nesting */\n/* eslint-disable promise/always-return */\n\n/**\n * Register click to show popup listener.\n *\n * @param {Number} targetUserId\n * @param {String} targetUser\n * @param {String} uniqueId\n */\nconst registerEventListener = (targetUserId, targetUser, uniqueId) => {\n    let link = document.getElementById(uniqueId);\n    link.addEventListener('click', function() {\n        CancelModal.create({\n            large: true,\n            title: Str.get_string('loginas_a', 'tool_muloginas', targetUser),\n            body: Str.get_string('creatingtoken', 'tool_muloginas')\n        })\n            .then(modal => {\n                let tokenExpired = false;\n\n                modal.setSmall();\n                modal.show();\n\n                // Handle hidden event.\n                modal.getRoot().on(ModalEvents.hidden, () => modal.destroy());\n\n                const request = {\n                    methodname: 'tool_muloginas_token_create',\n                    args: {\n                        targetuserid: targetUserId,\n                    }\n                };\n\n                const response = Ajax.call([request])[0];\n                response.then(function(data) {\n                    const context = {\n                        url: M.cfg.wwwroot + '/admin/tool/muloginas/loginas.php?token=' + data.token\n                    };\n                    Templates.render('tool_muloginas/popup_link', context).then((html) => {\n                        if (!tokenExpired) {\n                            modal.setBody(html);\n                        }\n                    }).catch(Notification.exception);\n\n                    setTimeout(function() {\n                        tokenExpired = true;\n                        Templates.render('tool_muloginas/popup_expired', {}).then((html) => {\n                            modal.setBody(html);\n                        }).catch(Notification.exception);\n                    }, (data.lifetime * 1000) - 500);\n\n                    /**\n                     * Close popup if token used.\n                     *\n                     * @param {string} token\n                     * @param {Modal} modal\n                     */\n                    const checkTokenUsed = (token, modal) => {\n                        const request = {\n                            methodname: 'tool_muloginas_token_check',\n                            args: {\n                                token: token,\n                            }\n                        };\n\n                        const response = Ajax.call([request])[0];\n                        response.then(function(data) {\n                            if (data.status === 3) {\n                                modal.hide();\n                            }\n                            if (data.status === 1) {\n                                setTimeout(function() {\n                                    checkTokenUsed(token, modal);\n                                }, 3000);\n                            }\n                        }).catch(Notification.exception);\n                    };\n\n                    checkTokenUsed(data.token, modal);\n                })\n                .catch(Notification.exception);\n\n                return modal;\n            })\n            .catch(Notification.exception);\n    });\n};\n\n/**\n * Initialise the popup.\n *\n * @param {object} param\n * @param {Number} param.targetuserid\n * @param {String} param.targetuser\n * @param {String} param.uniqueid\n */\nexport const init = ({targetuserid, targetuser, uniqueid}) => {\n    registerEventListener(targetuserid, targetuser, uniqueid);\n};\n\n"],"names":["_ref","targetuserid","targetuser","uniqueid","targetUserId","targetUser","uniqueId","document","getElementById","addEventListener","create","large","title","Str","get_string","body","then","modal","tokenExpired","setSmall","show","getRoot","on","ModalEvents","hidden","destroy","request","methodname","args","Ajax","call","data","context","url","M","cfg","wwwroot","token","render","html","setBody","catch","Notification","exception","setTimeout","lifetime","checkTokenUsed","status","hide"],"mappings":";;;;;;;o+BA+HoBA,WAACC,aAACA,aAADC,WAAeA,WAAfC,SAA2BA,eAvFlB,IAACC,aAAcC,WAAYC,SAA1BF,aAwFLH,aAxFmBI,WAwFLH,WAxFiBI,SAwFLH,SAvFrCI,SAASC,eAAeF,UAC9BG,iBAAiB,SAAS,iCACfC,OAAO,CACfC,OAAO,EACPC,MAAOC,IAAIC,WAAW,YAAa,iBAAkBT,YACrDU,KAAMF,IAAIC,WAAW,gBAAiB,oBAErCE,MAAKC,YACEC,cAAe,EAEnBD,MAAME,WACNF,MAAMG,OAGNH,MAAMI,UAAUC,GAAGC,sBAAYC,QAAQ,IAAMP,MAAMQ,kBAE7CC,QAAU,CACZC,WAAY,8BACZC,KAAM,CACF3B,aAAcG,sBAILyB,cAAKC,KAAK,CAACJ,UAAU,GAC7BV,MAAK,SAASe,YACbC,QAAU,CACZC,IAAKC,EAAEC,IAAIC,QAAU,2CAA6CL,KAAKM,0BAEjEC,OAAO,4BAA6BN,SAAShB,MAAMuB,OACpDrB,cACDD,MAAMuB,QAAQD,SAEnBE,MAAMC,sBAAaC,WAEtBC,YAAW,WACP1B,cAAe,qBACLoB,OAAO,+BAAgC,IAAItB,MAAMuB,OACvDtB,MAAMuB,QAAQD,SACfE,MAAMC,sBAAaC,aACN,IAAhBZ,KAAKc,SAAmB,WAQtBC,eAAiB,CAACT,MAAOpB,eACrBS,QAAU,CACZC,WAAY,6BACZC,KAAM,CACFS,MAAOA,QAIER,cAAKC,KAAK,CAACJ,UAAU,GAC7BV,MAAK,SAASe,MACC,IAAhBA,KAAKgB,QACL9B,MAAM+B,OAEU,IAAhBjB,KAAKgB,QACLH,YAAW,WACPE,eAAeT,MAAOpB,SACvB,QAERwB,MAAMC,sBAAaC,YAG1BG,eAAef,KAAKM,MAAOpB,UAE9BwB,MAAMC,sBAAaC,WAEb1B,SAEVwB,MAAMC,sBAAaC"}