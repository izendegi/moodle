{"version":3,"file":"capabilityformfield.min.js","sources":["../src/capabilityformfield.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD module to add filtering to the capability form field type.\n *\n * @module tool_editrolesbycap/capabilityformfield\n * @copyright  2012 The Open University\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport * as Str from 'core/str';\nimport Templates from 'core/templates';\nimport {exception as displayException} from 'core/notification';\n\nlet delayHandle = -1;\nconst noneErrorMessageId = 'id_noneerrormessage';\n/**\n * Render the search field element and initialize it's event handle.\n *\n * @param {String} selectorId\n */\nexport const initCapabilityFormField = async (selectorId) => {\n    const select = document.getElementById(selectorId);\n    if (!select) {\n        return;\n    }\n    const searchFieldId = selectorId + 'capabilitysearch';\n    const clearButtonid = selectorId + 'capabilityclear';\n    const nonematchString = await Str.get_string('nonematch', 'tool_editrolesbycap');\n    // Get any existing filter value.\n    const filterKey = 'captblflt';\n    const filterValue = sessionStorage.getItem(filterKey);\n    const context = {\n        id: searchFieldId,\n        clearbuttonid: clearButtonid,\n        value: filterValue,\n    };\n\n    Templates.renderForPromise('tool_editrolesbycap/filter_field', context).then(({html, js}) => {\n        // Insert it into the container of the select.\n        Templates.appendNodeContents(select.parentNode, html, js);\n        const noneMessageE = document.createElement('optgroup');\n        noneMessageE.setAttribute('label', nonematchString);\n        noneMessageE.setAttribute('id', noneErrorMessageId);\n        select.append(noneMessageE);\n        setVisible(noneMessageE, false);\n\n        // Wire the events so it actually does something.\n        const searchField = document.getElementById(searchFieldId);\n        const clearButton = document.getElementById(clearButtonid);\n\n        searchField.addEventListener('input', change);\n        searchField.filterKey = filterKey;\n        searchField.select = select;\n\n        clearButton.addEventListener('click', clear);\n        clearButton.filterKey = filterKey;\n        clearButton.select = select;\n        clearButton.searchField = searchField;\n\n        if (filterValue !== '') {\n            filter(filterKey, select);\n        }\n    }).catch(displayException);\n\n};\n\n/**\n * Filters the capability selector\n *\n * @param {String} filterKey\n * @param {HTMLElement} select\n */\nconst filter = (filterKey, select) => {\n    const clearButton = document.getElementById(select.getAttribute('id') + 'capabilityclear');\n    const searchField = document.getElementById(select.getAttribute('id') + 'capabilitysearch');\n    const filterText = searchField.value.toLowerCase();\n\n    sessionStorage.setItem(filterKey, filterText);\n    clearButton.disabled = (filterText === '');\n\n    let allHidden = true;\n    select.querySelectorAll('optgroup').forEach((optgroup) => {\n        setVisible(optgroup, false);\n        const lastGroup = optgroup;\n\n        optgroup.querySelectorAll('option').forEach((option) => {\n            const capName = option.textContent.toLowerCase();\n            if (capName.indexOf(filterText) >= 0) {\n                setVisible(lastGroup, true);\n                setVisible(option, true);\n                allHidden = false;\n            } else {\n                setVisible(option, false);\n            }\n        });\n    });\n    if (allHidden) {\n        const noneMessageE = document.getElementById(noneErrorMessageId);\n        setVisible(noneMessageE, true);\n    }\n};\n\n/**\n * Clears the filter value.\n *\n * @param {Event} e the current event\n */\nconst clear = (e) => {\n    e.target.searchField.value = '';\n    if (delayHandle !== -1) {\n        clearTimeout(delayHandle);\n        delayHandle = -1;\n    }\n    filter(e.target.filterKey, e.target.select);\n};\n\n/**\n * Event callback for when the filter value changes\n *\n * @param {Event} e the current event\n */\nconst change = (e) => {\n    let handle = setTimeout(function() {\n        filter(e.target.filterKey, e.target.select);\n    }, 100);\n    if (delayHandle !== -1) {\n        clearTimeout(delayHandle);\n    }\n    delayHandle = handle;\n};\n\n/**\n * Hide / Un-hide element.\n *\n * @param {Node} element\n * @param {Boolean} visible\n */\nconst setVisible = (element, visible) => {\n    if (visible) {\n        element.style.display = 'block';\n    } else {\n        element.style.display = 'none';\n    }\n};\n"],"names":["delayHandle","async","select","document","getElementById","selectorId","searchFieldId","clearButtonid","nonematchString","Str","get_string","filterValue","sessionStorage","getItem","context","id","clearbuttonid","value","renderForPromise","then","_ref","html","js","appendNodeContents","parentNode","noneMessageE","createElement","setAttribute","append","setVisible","searchField","clearButton","addEventListener","change","filterKey","clear","filter","catch","displayException","getAttribute","filterText","toLowerCase","setItem","disabled","allHidden","querySelectorAll","forEach","optgroup","lastGroup","option","textContent","indexOf","e","target","clearTimeout","handle","setTimeout","element","visible","style","display"],"mappings":";;;;;;;6EA0BIA,aAAe,mCAOoBC,MAAAA,mBAC7BC,OAASC,SAASC,eAAeC,gBAClCH,oBAGCI,cAAgBD,WAAa,mBAC7BE,cAAgBF,WAAa,kBAC7BG,sBAAwBC,IAAIC,WAAW,YAAa,uBAGpDC,YAAcC,eAAeC,QADjB,aAEZC,QAAU,CACZC,GAAIT,cACJU,cAAeT,cACfU,MAAON,gCAGDO,iBAAiB,mCAAoCJ,SAASK,MAAKC,WAACC,KAACA,KAADC,GAAOA,4BAEvEC,mBAAmBrB,OAAOsB,WAAYH,KAAMC,UAChDG,aAAetB,SAASuB,cAAc,YAC5CD,aAAaE,aAAa,QAASnB,iBACnCiB,aAAaE,aAAa,KA5BP,uBA6BnBzB,OAAO0B,OAAOH,cACdI,WAAWJ,cAAc,SAGnBK,YAAc3B,SAASC,eAAeE,eACtCyB,YAAc5B,SAASC,eAAeG,eAE5CuB,YAAYE,iBAAiB,QAASC,QACtCH,YAAYI,UAtBE,YAuBdJ,YAAY5B,OAASA,OAErB6B,YAAYC,iBAAiB,QAASG,OACtCJ,YAAYG,UA1BE,YA2BdH,YAAY7B,OAASA,OACrB6B,YAAYD,YAAcA,YAEN,KAAhBnB,aACAyB,OA/BU,YA+BQlC,WAEvBmC,MAAMC,gCAUPF,OAAS,CAACF,UAAWhC,gBACjB6B,YAAc5B,SAASC,eAAeF,OAAOqC,aAAa,MAAQ,mBAElEC,WADcrC,SAASC,eAAeF,OAAOqC,aAAa,MAAQ,oBACzCtB,MAAMwB,cAErC7B,eAAe8B,QAAQR,UAAWM,YAClCT,YAAYY,SAA2B,KAAfH,eAEpBI,WAAY,KAChB1C,OAAO2C,iBAAiB,YAAYC,SAASC,WACzClB,WAAWkB,UAAU,SACfC,UAAYD,SAElBA,SAASF,iBAAiB,UAAUC,SAASG,SACzBA,OAAOC,YAAYT,cACvBU,QAAQX,aAAe,GAC/BX,WAAWmB,WAAW,GACtBnB,WAAWoB,QAAQ,GACnBL,WAAY,GAEZf,WAAWoB,QAAQ,SAI3BL,UAAW,OACLnB,aAAetB,SAASC,eAnFX,uBAoFnByB,WAAWJ,cAAc,KAS3BU,MAASiB,IACXA,EAAEC,OAAOvB,YAAYb,MAAQ,IACR,IAAjBjB,cACAsD,aAAatD,aACbA,aAAe,GAEnBoC,OAAOgB,EAAEC,OAAOnB,UAAWkB,EAAEC,OAAOnD,SAQlC+B,OAAUmB,QACRG,OAASC,YAAW,WACpBpB,OAAOgB,EAAEC,OAAOnB,UAAWkB,EAAEC,OAAOnD,UACrC,MACkB,IAAjBF,aACAsD,aAAatD,aAEjBA,YAAcuD,QASZ1B,WAAa,CAAC4B,QAASC,WAErBD,QAAQE,MAAMC,QADdF,QACwB,QAEA"}