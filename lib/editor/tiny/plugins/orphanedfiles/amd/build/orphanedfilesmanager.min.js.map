{"version":3,"file":"orphanedfilesmanager.min.js","sources":["../src/orphanedfilesmanager.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Storage helper for the Moodle Tiny orphanedfiles plugin.\n *\n * @module     tiny_orphanedfiles/plugin\n * @copyright  2023 Andreas Siebel <andreas.siebel@schulportal.hessen.de>\n * @copyright  2023 Andreas Schenkel <andreas.schenkel@schulportal.hessen.de>\n * @author     2023 Andreas Siebel <andreas.siebel@schulportal.hessen.de>\n * @author     2023 Andreas Schenkel <andreas.schenkel@schulportal.hessen.de>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Options from \"./options\";\nimport Templates from 'core/templates';\nimport {exception as displayException} from 'core/notification';\nimport {deleteDraftFiles, getAllDraftFiles} from \"./repository\";\n\n/**\n * OrphanedfilesManager is created in main.js\n */\nexport default class OrphanedfilesManager {\n    constructor(params, editor) {\n        this.editor = editor;\n        this.elementId = editor.id;\n        this.editorContainer = editor.editorContainer;\n        // Read from options.js\n        this.draftItemId = params.draftItemId;\n        // Read userContextId from moodle\n        this.userContextId = params.userContextId;\n        // Read websitesetting from options.js\n        this.showReferenceCountEnabled = params.showReferenceCountEnabled;\n        this.orphanedFilesCounterOnly = params.orphanedFilesCounterOnly;\n        this.wwwRoot = params.wwwRoot;\n        this.baseUrl = {};\n\n        this.allFilesSet = new Set(); // Files\n        this.usedFilesSet = new Set(); // Set of file strings(!)\n\n        // Sets with filename strings\n        this.oldUsedFileNamesInEditor = new Set();\n        this.usedFilenamesInEditor = new Set();\n        this.editorFilenamesHaveChanged = true;\n\n        // Sets with file objects\n        this.oldOrphanedFilesSet = new Set();\n        this.orphanedFilesSet = new Set();\n        this.orphanedFilesSetHaveChanged = false;\n    }\n\n    /**\n     * Creates the wrapper for the Orphaned files area.\n     * The wrapper is a `div`-Element with id js-orphaned-wrapper-[elementid]\n     * and class js-orphaned-wrapper\n     */\n    createOrphanedArea() {\n        this.orphanedArea = document.createElement('div');\n        this.orphanedArea.id = 'tiny-js-orphaned-wrapper-' + this.elementId;\n        this.orphanedArea.className = 'tiny-orphaned-js-orphaned-wrapper';\n        this.orphanedArea.className = 'tiny-orphaned';\n        this.editorContainer.after(this.orphanedArea);\n\n        this.headerDiv = document.createElement('div');\n        this.headerDiv.id = `has-orphaned-files-${this.elementId}`;\n        this.headerDiv.classList.add(`hidden`);\n        this.headerDiv.innerHTML = '⟳ ... LOAD \"orphaned files indicator\", 8, 1';\n        this.orphanedArea.appendChild(this.headerDiv);\n\n        this.bodyDiv = document.createElement('div');\n        this.bodyDiv.id = `orphaned-files-${this.elementId}`;\n        // Template will be inserted into this DOM element.\n        this.bodyDiv.classList.add(`orphaned-files-content`);\n        this.bodyDiv.classList.add(`orphaned-files-content-${this.elementId}`);\n        this.bodyDiv.classList.add(`hidden`);\n        this.orphanedArea.appendChild(this.bodyDiv);\n\n    }\n\n    /**\n     * Updates the static allFilesSet. getAllDraftFiles creates AJAX-Calls do find the draft files\n     *\n     * @returns {*}\n     */\n    updateAllFiles() {\n        return new Promise((resolve, reject) => {\n            const draftItemId = Options.getDraftItemId(this.editor);\n            getAllDraftFiles(draftItemId)\n                .then(fileObject => {\n                    const result = JSON.parse(fileObject.files);\n                    this.allFilesSet = new Set([...result]); // Generate set from resultArray\n                    resolve(result);\n                    return null;\n                }).catch(error => {\n                reject(error); // Bei einem Fehler abgelehnt\n            });\n        });\n    }\n\n    /**\n     * Returns the used Files as array. updateUsedFilenamesInEditor must be called before updateUsedFiles.\n     * Update used Files is called *after* UpdateAllFiles\n     *\n     * @returns {array}\n     */\n    updateUsedFiles() {\n        return new Promise((resolve) => {\n            let i = 1;\n            // Get *files* from filename and filepath strings in editor (by filtering allFilesSet\n            for (const file of this.allFilesSet) {\n                file.className = 'file-' + i;\n                // Add individual information about the file e.g. dimensions, formated last modified date, ...\n                if (file.image_width && file.image_height) {\n                    file.dimensions = `${file.image_width}✕${file.image_height}`;\n                } else {\n                    file.dimensions = '';\n                }\n                const newDate = new Date(file.datemodified * 1000);\n                const dateString = newDate.toLocaleString();\n                file.datemodifiedFormated = dateString;\n\n                if (this.usedFilenamesInEditor.has(file.filepath + file.filename)) {\n                    this.usedFilesSet.add(file);\n                }\n                i = i + 1;\n            }\n            resolve(); // Erfolgreich aufgelöst\n        });\n    }\n\n    /**\n     * Updates the list of filenames used in the editor.\n     *\n     * This method scans the editor content for embedded file paths,\n     * extracts the filenames, and stores them as a Set in `usedFilenamesInEditor`.\n     * The search path is based on `wwwRoot`, `userContextId`, and `draftItemId`.\n     *\n     * It then checks whether the list of used files has changed since the last call.\n     * If it has, `editorFilenamesHaveChanged` is set to `true`; otherwise, it's set to `false`.\n     * The previous list is stored in `oldUsedFileNamesInEditor`.\n     */\n    updateUsedFilenamesInEditor() {\n        const editorContent = this.editor.getContent();\n        const baseUrl = `${this.wwwRoot}/draftfile.php/${this.userContextId}/user/draft/${this.draftItemId}/`;\n        const pattern = new RegExp(\"[\\\"']\" + baseUrl.replace(/[-/\\\\^$*+?.()|[\\]{}]/g, '\\\\$&') +\n            \"(?<filename>.+?)[\\\\?\\\"']\", 'gm');\n        // Get all used files in editor by searching editor content for filepatterns\n        this.usedFilenamesInEditor = new Set([...editorContent.matchAll(pattern)].map((match) => '/' +\n            decodeURIComponent(match.groups.filename)));\n        if (this.setsAreEqual(this.usedFilenamesInEditor, this.oldUsedFileNamesInEditor)) {\n            this.editorFilenamesHaveChanged = false;\n        } else {\n            this.editorFilenamesHaveChanged = true;\n        }\n        this.oldUsedFileNamesInEditor = this.usedFilenamesInEditor;\n    }\n\n    setsAreEqual(setA, setB) {\n        if (setA.size !== setB.size) {\n            return false;\n        }\n        for (let item of setA) {\n            if (!setB.has(item)) {\n                return false;\n            }\n        }\n        return true;\n    }\n\n    /**\n     * Compares to allFiles and usedFiles to find all orphaned files\n     *\n     * @returns {*[]}\n     */\n    updateOrphanedFiles() {\n        return new Promise((resolve) => {\n            this.oldOrphanedFilesSet = this.orphanedFilesSet;\n            this.orphanedFilesSet = new Set([...this.allFilesSet].filter(element => !this.usedFilesSet.has(element)));\n            const setsAreEqual = this.setsAreEqual(this.orphanedFilesSet, this.oldOrphanedFilesSet);\n            if (!setsAreEqual) {\n                this.orphanedFilesSetHaveChanged = true;\n            } else {\n                this.orphanedFilesSetHaveChanged = false;\n            }\n            resolve();\n        });\n    }\n\n    /**\n     * Deletes the selected files.\n     *\n     * @param {array} files List of all selected files @returns {null}\n     */\n    deleteSelectedFiles(files) {\n        const draftItemId = Options.getDraftItemId(this.editor);\n        deleteDraftFiles(draftItemId, files).then(() => {\n            this.update(true);\n            return null;\n        }).catch(() => {\n            // No tiny editor present\n        });\n    }\n\n    /**\n     * Updates static usedFiles and orphanedFiles and call to renderBody if orphanedFiles list changes.\n     *\n     * @param {bool} forceChanged true if the user deleted a draft file with a click in trash icon. (needed for file-deletion)\n     */\n    update(forceChanged = false) {\n        // Call updateUsedFilenamesInEditor to proof for changes in editor content\n        this.updateUsedFilenamesInEditor();\n\n        if (!this.editorFilenamesHaveChanged && !forceChanged) {\n            return;\n        }\n\n        this.updateAllFiles().then(() => {\n            return this.updateUsedFiles();\n        }).then(() => {\n            return this.updateOrphanedFiles();\n        }).then(() => {\n            if (this.orphanedFilesSetHaveChanged) {\n                // Only render Body if orphaned files changed\n                this.bodyDiv.classList.remove('hidden');\n                this.renderBody();\n            }\n            return null;\n        }).catch(() => {\n            // No tiny editor present\n        });\n        this.orphanedFilesSetHaveChanged = false;\n    }\n    /**\n     * Renders the list of orphaned files or in case of orphanedfilescounteronly renders just the number of orhaned files\n     *\n     * @returns {null}\n     */\n    renderBody() {\n        const numberoforphanedfiles = this.orphanedFilesSet.size;\n        if (numberoforphanedfiles !== 0) {\n            var orphanedfilescounteronly = this.orphanedFilesCounterOnly;\n            if (orphanedfilescounteronly) {\n                const context = {\n                    // Data to be rendered\n                    numberoforphanedfiles: numberoforphanedfiles,\n                };\n                Templates.renderForPromise('tiny_orphanedfiles/orphanedfilescounteronly', context).then(({html, js}) => {\n                    Templates.replaceNodeContents(`.orphaned-files-content-${this.elementId}`, html, js);\n                    return null;\n                }).catch(() => {\n                    // No tiny editor present\n                });\n            } else {\n                const websitesettings = Array();\n                // Just for documentation purpose: We can access settings by two different ways.\n                // We can access Options-Object or the data stored during construction.\n                websitesettings.showreferencecountenabled = this.showReferenceCountEnabled;\n                websitesettings.orphanedfilescounteronly = this.orphanedFilesCounterOnly;\n                const context = {\n                    // Data to be rendered\n                    orphanedFiles: Array.from(this.orphanedFilesSet),\n                    numberoforphanedfiles: numberoforphanedfiles,\n                    websitesettings: websitesettings,\n                    elementId: this.elementId\n                };\n                // Display Orphaned-Files-Table\n                Templates.renderForPromise('tiny_orphanedfiles/orphanedfiles', context).then(({html, js}) => {\n                    Templates.replaceNodeContents(`.orphaned-files-content-${this.elementId}`, html, js);\n                    return null;\n                }).then(() => {\n                    // Add Listener to dynamic items in Orphaned-Files-Table e.g. Delete Buttons\n                    return this.registerListener(Array.from(this.orphanedFilesSet));\n                }).catch((error) => displayException(error));\n            }\n        } else {\n            // In case of an undo the numberoforphanedfiles might get 0 during a table with orphand file is visible.\n            // To be cheap in this case we do NOT remove the table but set table like in all other cases where\n            // numberoforphanedfiles = 0 to hidden.\n            this.bodyDiv.classList.add('hidden');\n        }\n        return null;\n    }\n\n    /**\n     * Add Listener to dynamic items in Orphaned-Files-Table e.g. Delete Buttons\n     * @param {array} files The list of files which are display in Orphaned Files Table.\n     */\n    registerListener(files) {\n        // Add listener to the trash icons to be able to delete one single file.\n        files.forEach((file) => {\n            const deleteButton = document.querySelector(`#orphaned-files-${this.elementId} .orphaned-row.${file.className} span`);\n            deleteButton.addEventListener(\"click\", () => {\n                const singleFile = [];\n                singleFile.push({'filepath': file.filepath, 'filename': file.filename});\n                // We can use deleteSelectedFiles() to delete a single file triggered by the trash icon click.\n                this.deleteSelectedFiles(singleFile);\n            });\n        });\n\n        // Add listener to the delete button to look for each selected file that will be deleted.\n        let selectedFiles = [];\n        const deleteSelectedButton = document.querySelector(`#orphaned-files-${this.elementId} button.deleteselected`);\n        deleteSelectedButton.addEventListener(\"click\", () => {\n            for (const file of files) {\n                const select = document.querySelector(`#orphaned-files-${this.elementId} .orphaned-row.${file.className} input`);\n                if (select.checked) {\n                    selectedFiles.push({'filepath': file.filepath, 'filename': file.filename});\n                }\n            }\n            this.deleteSelectedFiles(selectedFiles);\n        });\n    }\n\n}\n"],"names":["constructor","params","editor","elementId","id","editorContainer","draftItemId","userContextId","showReferenceCountEnabled","orphanedFilesCounterOnly","wwwRoot","baseUrl","allFilesSet","Set","usedFilesSet","oldUsedFileNamesInEditor","usedFilenamesInEditor","editorFilenamesHaveChanged","oldOrphanedFilesSet","orphanedFilesSet","orphanedFilesSetHaveChanged","createOrphanedArea","orphanedArea","document","createElement","this","className","after","headerDiv","classList","add","innerHTML","appendChild","bodyDiv","updateAllFiles","Promise","resolve","reject","Options","getDraftItemId","then","fileObject","result","JSON","parse","files","catch","error","updateUsedFiles","i","file","image_width","image_height","dimensions","dateString","Date","datemodified","toLocaleString","datemodifiedFormated","has","filepath","filename","updateUsedFilenamesInEditor","editorContent","getContent","pattern","RegExp","replace","matchAll","map","match","decodeURIComponent","groups","setsAreEqual","setA","setB","size","item","updateOrphanedFiles","filter","element","deleteSelectedFiles","update","forceChanged","remove","renderBody","numberoforphanedfiles","context","renderForPromise","_ref","html","js","replaceNodeContents","websitesettings","Array","showreferencecountenabled","orphanedfilescounteronly","orphanedFiles","from","_ref2","registerListener","forEach","querySelector","addEventListener","singleFile","push","selectedFiles","checked"],"mappings":"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"}