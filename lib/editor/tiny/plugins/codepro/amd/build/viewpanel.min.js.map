{"version":3,"file":"viewpanel.min.js","sources":["../src/viewpanel.js"],"sourcesContent":["/* eslint-disable no-console */\n/* eslint-disable max-len */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny CodePro plugin.\n *\n * @module      tiny_codepro/plugin\n * @copyright   2023-2025 Josep Mulet Pol <pep.mulet@gmail.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport { getDefaultUI, isFullscreen } from \"./options\";\nimport { ViewManager } from \"./viewmanager\";\n\n/**\n * Keep track of all active viewPanels in the page.\n * @type {Record<string, ViewManager>}\n **/\nconst HARDCODED_HEIGHT = '350px';\nconst activeViewPanels = new Map();\nlet submitListenerAction = null;\n\nexport class ViewPanelManager extends ViewManager {\n    constructor(editor, opts) {\n        super(editor, opts);\n        this.translations = this.opts.translations ?? [];\n        this.isViewCreated = false;\n    }\n\n    _tShow() {\n        this.editor.execCommand('ToggleView', false, 'codepro');\n    }\n    _tClose() {\n        this.editor.execCommand('ToggleView', false, 'codepro');\n    }\n    _tDestroy() {\n        activeViewPanels.delete(this.editor.id);\n    }\n\n    _tAdjustOptions(options) {\n        // View-panel case. Detect changes on CM editor.\n        options.changesListener = () => {\n            this.pendingChanges = true;\n        };\n        // If the form containing the editor has no submit button, must rely on blur to implement autosave.\n        const hasFormSubmit = this.editor.container.closest('form')?.querySelector('[type=\"submit\"]');\n        if (!hasFormSubmit) {\n            // Blur strategy on this resource.\n            options.onblur = () => {\n                if (this.pendingChanges) {\n                    this._quickSave();\n                }\n            };\n        }\n        // Always enable linewrapping in panel view when not in Fullscreen.\n        const isFS = isFullscreen(this.editor);\n        if (!isFS) {\n            options.lineWrapping = true;\n        }\n    }\n\n    async _tCreate() {\n        // Only one instance per editor has to be registered.\n        if (this.isViewCreated) {\n            return;\n        }\n        this.isViewCreated = true;\n        this._registerIcons();\n        const viewSpec = this._createViewSpec();\n        this.editor.ui.registry.addView(\"codepro\", viewSpec);\n    }\n\n    _createUI(api) {\n        const container = api.getContainer();\n        container.classList.add('tiny_codepro-view__pane');\n        const shadowRoot = container.attachShadow({ mode: \"open\" });\n        const shadowStyles = document.createElement('style');\n        shadowStyles.textContent = `\n        .cm-editor.cm-focused {\n            border-color: #86b7fe;\n            outline: 0!important;\n            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);\n            border-radius: 4px;\n        }\n        .cm-editor {\n            height: 100%;\n            width: 100%;\n        }\n        .cm-scroller {\n            overscroll-behavior: contain;\n        }\n        .tiny_codepro-loader {\n            position: absolute;\n            z-index: 100;\n            top: 50%;\n            left: 50%;\n            width: 16px;\n            height: 16px;\n            border-radius: 50%;\n            background-color: #999;\n            box-shadow: 32px 0 #999, -32px 0 #999;\n            animation: tiny_codepro-flash 0.5s ease-out infinite alternate;\n        }\n        @keyframes tiny_codepro-flash {\n            0% {\n            background-color: #FFF2;\n            box-shadow: 32px 0 #FFF2, -32px 0 #999;\n            }\n            50% {\n            background-color: #999;\n            box-shadow: 32px 0 #FFF2, -32px 0 #FFF2;\n            }\n            100% {\n            background-color: #FFF2;\n            box-shadow: 32px 0 #999, -32px 0 #FFF2;\n            }\n        }\n        @media only screen and (max-width: 767px) {\n            .cm-gutters.cm-minimap-gutter {\n                display: none!important;\n            }\n        }`;\n        shadowRoot.appendChild(shadowStyles);\n        this.codeEditorElement = shadowRoot;\n    }\n\n    _setButtonsState() {\n        // eslint-disable-next-line no-unused-vars\n        const { btnDescreaseFontsize, btnIncreaseFontsize, btnTheme, btnAccept } = this.domElements;\n\n        // Style issue\n        btnDescreaseFontsize.style.marginRight = '0';\n        btnIncreaseFontsize.style.marginLeft = '0';\n\n        // Set the toggle state\n        const isDark = this.preferencesSrv.get('theme', 'light') === 'dark';\n        ViewManager.safeInnerHTML(btnTheme, 'span', isDark ? ViewManager.icons.moon : ViewManager.icons.sun);\n\n        if (isDark) {\n            this.parentContainer.classList.add('tiny_codepro-dark');\n        } else {\n            this.parentContainer.classList.remove('tiny_codepro-dark');\n        }\n\n        // Style issue\n        const btnAcceptSvg = btnAccept?.querySelector('svg');\n        if (btnAcceptSvg) {\n            btnAcceptSvg.style.marginRight = '5px';\n        }\n\n        // In panel mode, the initial fs state is decided by tox-fullscreen class.\n        if (isFullscreen(this.editor)) {\n            this.domElements.btnWrap.style.display = 'initial';\n            if (this.parentContainer) {\n                this.parentContainer.style.height = '';\n            }\n        } else {\n            // Unable linewrapping if not in fullscreen\n            this.domElements.btnWrap.style.display = 'none';\n            // Set a hardcoded height\n            if (this.parentContainer) {\n                this.parentContainer.style.height = HARDCODED_HEIGHT;\n            }\n        }\n    }\n\n    _createViewSpec() {\n        const buttonsSpec = this._createButtons();\n        const viewSpec = {\n            buttons: buttonsSpec,\n            onShow: async (api) => {\n                // Before Tiny loses focus, get its contents and head position\n                const docHead = await this.loadDocInfo();\n                // Register this panel as active.\n                activeViewPanels.set(this.editor.id, this);\n\n                if (!this.codeEditorElement) {\n                    // Make sure the UI is created.\n                    this._createUI(api);\n                    // Register a global listener to submit event.\n                    // Autosave all editors before submitting the form.\n                    const submitButtons = document.querySelectorAll('button[type=\"submit\"],input[type=\"submit\"]');\n                    if (submitButtons.length && !submitListenerAction) {\n                        submitListenerAction = () => {\n                            try {\n                                Array.from(activeViewPanels.values())\n                                    .filter(vp => vp.pendingChanges)\n                                    .forEach(viewPanel => viewPanel._quickSave());\n                                submitButtons.forEach(btn => btn.removeEventListener('click', submitListenerAction));\n                            } catch (ex) {\n                                console.error(ex);\n                            }\n                        };\n                        submitButtons.forEach(btn => btn.addEventListener('click', submitListenerAction));\n                    }\n                }\n\n                // Store references to the header buttons to have access from the button actions.\n                const container = api.getContainer();\n                this.parentContainer = container.parentElement;\n\n                const headerButtonElements = this.parentContainer?.querySelectorAll('.tox-view__header button') ?? [];\n                // Convert NodeList to an array for easier reverse access\n                const buttonsArray = Array.from(headerButtonElements);\n                const bLen = buttonsArray.length;\n\n                this.domElements = {\n                    root: this.parentContainer,\n                    btnDescreaseFontsize: buttonsArray[bLen - 6],\n                    btnIncreaseFontsize: buttonsArray[bLen - 5],\n                    btnTheme: buttonsArray[bLen - 4],\n                    btnWrap: buttonsArray[bLen - 3],\n                    btnPrettify: buttonsArray[bLen - 2],\n                    btnAccept: buttonsArray[bLen - 1],\n                };\n\n                // Hack to turn regular buttons into toggle ones.\n                this._setButtonsState();\n                this._showSpinner(this.codeEditorElement);\n                // Add the codeEditor (CodeMirror) in the selected UI element.\n                await this.attachCodeEditor(this.codeEditorElement, docHead);\n                this._hideSpinner(this.codeEditorElement);\n            },\n            onHide: () => {\n                // Remove hardcoded height\n                if (this.parentContainer) {\n                    this.parentContainer.style.height = '';\n                }\n            }\n        };\n        return viewSpec;\n    }\n\n    _registerIcons() {\n        Object.keys(ViewManager.icons).forEach(key => {\n            this.editor.ui.registry.addIcon(`tiny_codepro-${key}`, ViewManager.icons[key]);\n        });\n    }\n\n    _createButtons() {\n        const [opendialogStr, fullscreenStr, themesStr, linewrapStr, prettifyStr, decreaseFontsizeStr, increaseFontsizeStr] = this.translations;\n\n        const buttons = [\n            {\n                type: 'button',\n                text: ' ',\n                icon: 'tiny_codepro-fullscreen',\n                tooltip: fullscreenStr,\n                onAction: () => {\n                    const isFS = !isFullscreen(this.editor);\n                    if (isFS) {\n                        this.domElements.btnWrap.style.display = 'initial';\n                        if (this.parentContainer) {\n                            this.parentContainer.style.height = '';\n                        }\n                    } else {\n                        // Unable linewrapping if not in fullscreen.\n                        this.domElements.btnWrap.style.display = 'none';\n                        // Set a hardcoded height.\n                        if (this.parentContainer) {\n                            this.parentContainer.style.height = HARDCODED_HEIGHT;\n                        }\n                        // Always show with linewrapping on\n                        if (!this.codeEditor.config.lineWrapping) {\n                            this.toggleLineWrapping(false);\n                        }\n                    }\n                    // Never store fs state in panel mode.\n                    this.editor.execCommand('mceFullScreen');\n                }\n            },\n            {\n                type: 'button',\n                text: '',\n                icon: 'tiny_codepro-decreasefontsize',\n                tooltip: decreaseFontsizeStr,\n                onAction: this.decreaseFontsize.bind(this)\n            },\n            {\n                type: 'button',\n                text: '',\n                icon: 'tiny_codepro-increasefontsize',\n                tooltip: increaseFontsizeStr,\n                onAction: this.increaseFontsize.bind(this)\n            },\n            {\n                type: 'button',\n                text: ' ',\n                icon: 'tiny_codepro-sun',\n                tooltip: themesStr,\n                onAction: this.toggleTheme.bind(this)\n            },\n            // Linewrapping causes problems in panel view\n            {\n                type: 'button',\n                text: ' ',\n                icon: 'tiny_codepro-exchange',\n                tooltip: linewrapStr,\n                onAction: this.toggleLineWrapping.bind(this)\n            },\n            {\n                type: 'button',\n                text: ' ',\n                icon: 'tiny_codepro-magic',\n                tooltip: prettifyStr,\n                onAction: () => this.prettify(this.domElements.btnPrettify)\n            },\n            {\n                type: 'button',\n                text: ' tinyMCE',\n                icon: 'tiny_codepro-tinymce',\n                buttonType: 'primary',\n                onAction: this.accept.bind(this)\n            },\n        ];\n\n        // If user is allowed to switch views, add the button\n        const defaultUI = getDefaultUI(this.editor) ?? 'dialog';\n        const canuserswitchui = defaultUI.startsWith('user:');\n        if (canuserswitchui) {\n            buttons.unshift({\n                type: 'button',\n                text: ' ',\n                icon: 'tiny_codepro-eye',\n                tooltip: opendialogStr,\n                onAction: this.switchViews.bind(this)\n            });\n        }\n        return buttons;\n    }\n}\n"],"names":["activeViewPanels","Map","submitListenerAction","ViewPanelManager","ViewManager","constructor","editor","opts","translations","this","isViewCreated","_tShow","execCommand","_tClose","_tDestroy","delete","id","_tAdjustOptions","options","changesListener","pendingChanges","container","closest","_this$editor$containe","querySelector","onblur","_quickSave","lineWrapping","_registerIcons","viewSpec","_createViewSpec","ui","registry","addView","_createUI","api","getContainer","classList","add","shadowRoot","attachShadow","mode","shadowStyles","document","createElement","textContent","appendChild","codeEditorElement","_setButtonsState","btnDescreaseFontsize","btnIncreaseFontsize","btnTheme","btnAccept","domElements","style","marginRight","marginLeft","isDark","preferencesSrv","get","safeInnerHTML","icons","moon","sun","parentContainer","remove","btnAcceptSvg","btnWrap","display","height","buttons","_createButtons","onShow","async","docHead","loadDocInfo","set","submitButtons","querySelectorAll","length","Array","from","values","filter","vp","forEach","viewPanel","btn","removeEventListener","ex","console","error","addEventListener","parentElement","headerButtonElements","buttonsArray","bLen","root","btnPrettify","_showSpinner","attachCodeEditor","_hideSpinner","onHide","Object","keys","key","addIcon","opendialogStr","fullscreenStr","themesStr","linewrapStr","prettifyStr","decreaseFontsizeStr","increaseFontsizeStr","type","text","icon","tooltip","onAction","codeEditor","config","toggleLineWrapping","decreaseFontsize","bind","increaseFontsize","toggleTheme","prettify","buttonType","accept","startsWith","unshift","switchViews"],"mappings":"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"}