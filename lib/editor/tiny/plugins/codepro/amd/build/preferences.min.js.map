{"version":3,"file":"preferences.min.js","sources":["../src/preferences.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\nimport { getUserPrefs } from \"./options\";\nimport { getRemoteService } from \"./remotesrv\";\n\n/**\n * Default preferences\n */\nconst defaultPrefs = {\n    theme: \"light\",\n    wrap: true,\n    fs: false,\n    fontsize: 11,\n    minimap: true,\n    view: undefined,\n};\n\n/**\n * Preferences service (stateful)\n */\nclass PreferencesService {\n    static SAVE_DELAY = 1000; // ms\n    /**\n     * @param {TinyMCEEditor} editor\n     */\n    constructor(editor) {\n        this.editor = editor;\n        this.preferences = this._loadPrefs();\n        // Never force saving default prefs.\n        this._lastSavedJson = JSON.stringify(this.preferences);\n        this._saveTimeout = null;\n        this._dirty = false;\n    }\n\n    /**\n     * Load preferences from remote / local storage\n     * @returns {object}\n     */\n    _loadPrefs() {\n        const remotePrefsJson = getUserPrefs(this.editor);\n        const localPrefsJson = localStorage.getItem(\"tiny-codepro\");\n\n        let storedParsed = {};\n\n        try {\n            if (remotePrefsJson) {\n                storedParsed = JSON.parse(remotePrefsJson);\n            } else if (localPrefsJson) {\n                const localPrefs = JSON.parse(localPrefsJson);\n                // Migrate old local prefs to remote\n                getRemoteService().saveUserPref(localPrefsJson);\n                storedParsed = localPrefs;\n            }\n        } catch (ex) {\n            // eslint-disable-next-line no-console\n            console.error(\"Cannot parse JSON user preferences\", ex);\n        }\n\n        return { ...defaultPrefs, ...storedParsed };\n    }\n\n    /**\n     * Get a preference value\n     * @param {string} key\n     * @param {*} [def]\n     * @returns {*}\n     */\n    get(key, def) {\n        return this.preferences[key] ?? def;\n    }\n\n    /**\n     * Set a preference value\n     * @param {string} key\n     * @param {*} value\n     * @param {boolean} [save=true]\n     */\n    set(key, value, save = true) {\n        this._dirty = this._dirty || this.preferences[key] !== value;\n        this.preferences[key] = value;\n        if (save && this._dirty) {\n            this._scheduleSave();\n        }\n    }\n\n    _scheduleSave() {\n        if (this._saveTimeout) {\n            clearTimeout(this._saveTimeout);\n        }\n        this._saveTimeout = setTimeout(() => this._save(), PreferencesService.SAVE_DELAY);\n    }\n\n    /**\n     * Save preferences (remote + local)\n     * @param {object} [prefs]\n     */\n    _save(prefs = this.preferences) {\n        if (this._saveTimeout) {\n            clearTimeout(this._saveTimeout);\n        }\n        const json = JSON.stringify(prefs);\n        if (json === this._lastSavedJson) {\n            return;\n        }\n        this._lastSavedJson = json;\n        // Keep local copy for backward compatibility\n        localStorage.setItem(\"tiny-codepro\", json);\n        this._dirty = false;\n        // Beware this call is async!\n        getRemoteService().saveUserPref(json);\n    }\n\n    /**\n     * Force save preferences (remote + local)\n     */\n    flush() {\n        if (!this._dirty) {\n            return;\n        }\n        this._save();\n        this._dirty = false;\n    }\n\n    /**\n     * Get all preferences\n     * @returns {object}\n     */\n    all() {\n        return { ...this.preferences };\n    }\n}\n\n/**\n * Preferences service instances per editor\n * @type {Map<string, PreferencesService>}\n */\nconst instances = new Map();\n\n/**\n * Get PreferencesService for an editor\n *\n * @param {TinyMCEEditor} editor\n * @returns {PreferencesService}\n */\nconst getPreferencesSrv = (editor) => {\n    if (!editor) {\n        throw new Error(\"PreferencesService requires an editor instance\");\n    }\n\n    if (!instances.has(editor.id)) {\n        instances.set(editor.id, new PreferencesService(editor));\n    }\n\n    return instances.get(editor.id);\n};\n\nexport { PreferencesService, getPreferencesSrv };"],"names":["defaultPrefs","theme","wrap","fs","fontsize","minimap","view","undefined","PreferencesService","constructor","editor","preferences","this","_loadPrefs","_lastSavedJson","JSON","stringify","_saveTimeout","_dirty","remotePrefsJson","localPrefsJson","localStorage","getItem","storedParsed","parse","localPrefs","saveUserPref","ex","console","error","get","key","def","set","value","save","_scheduleSave","clearTimeout","setTimeout","_save","SAVE_DELAY","prefs","json","setItem","flush","all","instances","Map","Error","has","id"],"mappings":"4OAqBMA,aAAe,CACjBC,MAAO,QACPC,MAAM,EACNC,IAAI,EACJC,SAAU,GACVC,SAAS,EACTC,UAAMC,SAMJC,qCACkB,IAIpBC,YAAYC,aACHA,OAASA,YACTC,YAAcC,KAAKC,kBAEnBC,eAAiBC,KAAKC,UAAUJ,KAAKD,kBACrCM,aAAe,UACfC,QAAS,EAOlBL,mBACUM,iBAAkB,yBAAaP,KAAKF,QACpCU,eAAiBC,aAAaC,QAAQ,oBAExCC,aAAe,UAGXJ,gBACAI,aAAeR,KAAKS,MAAML,sBACvB,GAAIC,eAAgB,OACjBK,WAAaV,KAAKS,MAAMJ,kDAEXM,aAAaN,gBAChCG,aAAeE,YAErB,MAAOE,IAELC,QAAQC,MAAM,qCAAsCF,UAGjD,IAAK3B,gBAAiBuB,cASjCO,IAAIC,IAAKC,YACEpB,KAAKD,YAAYoB,MAAQC,IASpCC,IAAIF,IAAKG,WAAOC,qEACPjB,OAASN,KAAKM,QAAUN,KAAKD,YAAYoB,OAASG,WAClDvB,YAAYoB,KAAOG,MACpBC,MAAQvB,KAAKM,aACRkB,gBAIbA,gBACQxB,KAAKK,cACLoB,aAAazB,KAAKK,mBAEjBA,aAAeqB,YAAW,IAAM1B,KAAK2B,SAAS/B,mBAAmBgC,YAO1ED,YAAME,6DAAQ7B,KAAKD,YACXC,KAAKK,cACLoB,aAAazB,KAAKK,oBAEhByB,KAAO3B,KAAKC,UAAUyB,OACxBC,OAAS9B,KAAKE,sBAGbA,eAAiB4B,KAEtBrB,aAAasB,QAAQ,eAAgBD,WAChCxB,QAAS,oCAEKQ,aAAagB,OAMpCE,QACShC,KAAKM,cAGLqB,aACArB,QAAS,GAOlB2B,YACW,IAAKjC,KAAKD,mEAQnBmC,UAAY,IAAIC,+BAQKrC,aAClBA,aACK,IAAIsC,MAAM,yDAGfF,UAAUG,IAAIvC,OAAOwC,KACtBJ,UAAUb,IAAIvB,OAAOwC,GAAI,IAAI1C,mBAAmBE,SAG7CoC,UAAUhB,IAAIpB,OAAOwC"}