define("mod_board/ajax_form/modal",["exports","jquery","core/modal","core/fragment","core/notification","core_form/events","core_form/changechecker","core/pending"],(function(_exports,_jquery,_modal,_fragment,Notification,FormEvents,FormChangeChecker,_pending){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_jquery=_interopRequireDefault(_jquery),_modal=_interopRequireDefault(_modal),_fragment=_interopRequireDefault(_fragment),Notification=_interopRequireWildcard(Notification),FormEvents=_interopRequireWildcard(FormEvents),FormChangeChecker=_interopRequireWildcard(FormChangeChecker),_pending=_interopRequireDefault(_pending);const SELECTORS_CANCEL_BUTTON='[data-action="cancel"]',SELECTORS_SUBMIT_BUTTON='[data-action="submit"]',SELECTORS_SUBMITTING_ICON_CONTAINER='[data-region="submitting-icon-container"]',STATUSES_CANCELLED="cancelled",STATUSES_RENDER="render",STATUSES_SUBMITTED="submitted",ACTIONS_REDIRECT="redirect",ACTIONS_RELOAD="reload";class AjaxFormModal extends _modal.default{constructor(root){super(root),this.reloadingForm=!1,this.formUrl=null,this.formSubmittedAction=null,this.submitButton=this.getFooter().find(SELECTORS_SUBMIT_BUTTON),this.cancelButton=this.getFooter().find(SELECTORS_CANCEL_BUTTON),this.submittingContainer=this.getFooter().find(SELECTORS_SUBMITTING_ICON_CONTAINER)}configure(modalConfig){this.formUrl=modalConfig.formUrl,this.formSubmittedAction=modalConfig.formSubmittedAction,modalConfig.show=!1,modalConfig.removeOnClose=!0,super.configure(modalConfig),"lg"!==modalConfig.formSize&&"xl"!==modalConfig.formSize||this.getModal().addClass("modal-".concat(modalConfig.formSize)),this.show()}registerEventListeners(){super.registerEventListeners(),this.registerCloseOnCancel(),this.registerOnSubmit()}registerOnSubmit(){this.getRoot().on("click",this.getActionSelector("submit"),this.submitFormAjax.bind(this)),this.getRoot().on("submit","form",(e=>{e.preventDefault()}))}setSubmitButtonText(value){let ariaLabel=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";this.submitButton.text(value),""===ariaLabel?this.submitButton.removeAttr("aria-label"):this.submitButton.attr("aria-label",ariaLabel)}setCancelButtonText(value){let ariaLabel=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";this.cancelButton.text(value),""===ariaLabel?this.cancelButton.removeAttr("aria-label"):this.cancelButton.attr("aria-label",ariaLabel)}getForm(){return this.getRoot().find("form")[0]}validateElements(){FormEvents.notifyFormSubmittedByJavascript(this.getForm());const invalid=this.getRoot().find('[aria-invalid="true"], .error');return!invalid.length||(invalid.first().focus(),!1)}submitFormAjax(e){if(e.preventDefault(),!this.validateElements())return;const formData=this.getRoot().find("form").serialize();FormChangeChecker.resetAllFormDirtyStates(),this.reloadForm(formData)}reloadForm(formData){if(this.reloadingForm)return;this.reloadingForm=!0;const pendingPromise=new _pending.default("mod_board/modal_ajax_form:reload");this.disableSubmitButton();const settings={async:!0,data:formData,dataType:"json",processData:!1,timeout:0,type:"POST"},renderPromise=_jquery.default.Deferred();""===formData?this.setBody(renderPromise.promise()):this.submittingContainer.removeClass("hidden"),_jquery.default.ajax(this.formUrl,settings).done((response=>{var _response$data;if(!response)throw new Error("Invalid server response");if(response.error)Notification.exception(response);else if(null!==(_response$data=response.data)&&void 0!==_response$data&&_response$data.status){var _response$data$submit,_response$data$cancel;if(response.data.status===STATUSES_RENDER)""!==formData&&this.setBody(renderPromise.promise()),renderPromise.resolve(response.data.html,_fragment.default.processCollectedJavascript(response.data.javascript)),this.setTitle(response.data.dialogtitle),this.setSubmitButtonText(response.data.submittext,null!==(_response$data$submit=response.data.submitarialabel)&&void 0!==_response$data$submit?_response$data$submit:""),this.setCancelButtonText(response.data.canceltext,null!==(_response$data$cancel=response.data.cancelarialabel)&&void 0!==_response$data$cancel?_response$data$cancel:""),this.submitButton.removeClass("hidden"),this.enableSubmitButton();else if(response.data.status===STATUSES_CANCELLED)this.destroy();else if(response.data.status===STATUSES_SUBMITTED)if(renderPromise.resolve("",""),"function"==typeof this.formSubmittedAction){const callback=this.formSubmittedAction;this.destroy(),callback(response.data.callbackdata)}else this.formSubmittedAction===ACTIONS_RELOAD?(FormChangeChecker.disableAllChecks(),window.location.reload()):this.formSubmittedAction===ACTIONS_REDIRECT?(FormChangeChecker.disableAllChecks(),window.location=response.data.redirecturl):this.destroy();else Notification.exception(new Error("Invalid form data.status value received"))}else Notification.exception(new Error("Invalid server response"))})).catch((ex=>{Notification.exception(ex)})).always((()=>{pendingPromise.resolve(),this.submittingContainer.addClass("hidden"),this.reloadingForm=!1}))}disableSubmitButton(){this.submitButton.prop("disabled",!0)}enableSubmitButton(){this.submitButton.prop("disabled",!1)}show(){return this.reloadForm(""),super.show()}hide(){const form=this.getForm();FormEvents.notifyFormSubmittedByJavascript(form,!0),FormChangeChecker.resetFormDirtyState(form),super.hide()}}return _exports.default=AjaxFormModal,_defineProperty(AjaxFormModal,"TYPE","mod_board-ajax_form_modal"),_defineProperty(AjaxFormModal,"TEMPLATE","mod_board/ajax_form/modal"),AjaxFormModal.registerModalType(),_exports.default}));

//# sourceMappingURL=modal.min.js.map