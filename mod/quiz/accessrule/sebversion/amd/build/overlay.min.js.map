{"version":3,"file":"overlay.min.js","sources":["../src/overlay.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * Script to show a modal overlay in case of outdated versions of the\n * Safe Exam Browser.\n *\n * @module     quizaccess_sebversion/overlay\n * @copyright  2025, Philipp Imhof\n * @author     Philipp Imhof\n * @license    https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as String from 'core/str';\n\n/**\n * Default messages, in case the strings cannot be fetched from the language file.\n */\nconst DEFAULT_MESSAGES = {\n    'update': 'Please update your Safe Exam Browser in order to attempt this quiz. You need at least version ',\n    'invalid': 'The version of your Safe Exam Browser could not be determined. '\n        + 'Please download the most recent official version and try again',\n};\n\n/**\n * Setup the environment, check the version and react accordingly.\n *\n * @param {string} minVersionWin the minimum version of SEB on Windows, e. g. 3.10.0\n * @param {string} minVersionMac the minimum version of SEB on macOS (Mac/iPad), e. g. 3.6.0\n * @param {boolean} behat wheter we are currently in a Behat acceptance test.\n */\nexport const init = async(minVersionWin, minVersionMac, behat) => {\n    testisVersionAtLeast();\n    // Inside Safe Exam Browser, there is a global SafeExamBrowser object with, among others,\n    // a version attribute. The object is not normally available in other browsers. As acceptance\n    // tests use regular browsers, we will have to simulate being in Safe Exam Browser. The\n    // test feature will have left the desired version string in the local storage. We create\n    // the SafeExamBrowser global object and copy the version string from the local storage. If\n    // the simulated version is the special string \"no SEB\", we do not create the SafeExamBrowser\n    // object in order to simulate the fact that there is no SEB at all.\n    if (behat) {\n        const simulatedVersion = localStorage.getItem('quizaccess_sebversion_versionString');\n        if (simulatedVersion !== 'no SEB') {\n            window.SafeExamBrowser = {\n                'version': simulatedVersion,\n            };\n        }\n\n        // If we are in a Behat test, we will also run \"unit tests\" for the version checker.\n        testisVersionAtLeast();\n    }\n\n    // Fetch the version string from the SafeExamBrowser object, as described above.\n    const versionString = window.SafeExamBrowser?.version ?? '';\n\n    // By default, we assume that the overlay will be needed.\n    let overlayNeeded = true;\n    let targetVersion = '';\n\n    // The version string has the following format, depending on the platform:\n    // - Safe Exam Browser_macOS_3.5_15487_org.safeexambrowser.SafeExamBrowser\n    // - Safe Exam Browser_iOS_3.5_15487_org.safeexambrowser.SafeExamBrowser\n    // - SEB_Windows_3.9.0.787\n    // The formats can be found in the SafeExamBrowser GitHub repositories:\n    // -> seb-mac/Classes/BrowserComponents/SEBBrowserController.m --> look for appVersion\n    // -> seb-mac/SEB/SEBViewController.m --> look for appVersion (iOS)\n    // -> seb-win-refactoring/SafeExamBrowser.Browser/Content/Api.js\n    // If the string does not match either of these formats, something could be\n    // wrong, e. g. it could be a custom build.\n    if (versionString.includes('macOS') || versionString.includes('iOS')) {\n        overlayNeeded = !checkMacVersion(versionString, minVersionMac);\n        targetVersion = minVersionMac;\n    } else if (versionString.includes('Windows')) {\n        overlayNeeded = !checkWinVersion(versionString, minVersionWin);\n        targetVersion = minVersionWin;\n    } else {\n        overlayNeeded = true;\n    }\n\n    if (overlayNeeded) {\n        await addOverlay(targetVersion);\n    }\n};\n\n/**\n * Take the version string, as declared by a Mac build of SEB, and extract the version number for\n * comparision with the the requested minimum version. Comparison is done by a helper function.\n *\n * @param {String} versionString the version string as declared by the browser\n * @param {String} minVersion the requested minimum version of SEB\n * @returns {boolean}\n */\nconst checkMacVersion = (versionString, minVersion) => {\n    // The version string on Mac must have exactly five parts. The third part will be the\n    // version number, e. g. Safe Exam Browser_macOS_3.5_15487_org.safeexambrowser.SafeExamBrowser\n    // or Safe Exam Browser_iOS_3.5_15487_org.safeexambrowser.SafeExamBrowser\n    const parts = versionString.split('_');\n    if (parts.length !== 5) {\n        return false;\n    }\n\n    return isVersionAtLeast(parts[2], minVersion);\n};\n\n/**\n * Take the version string, as declared by a Windows build of SEB, and extract the version number for\n * comparision with the the requested minimum version. Comparison is done by a helper function.\n *\n * @param {String} versionString the version string as declared by the browser\n * @param {String} minVersion the requested minimum version of SEB\n * @returns {boolean}\n */\nconst checkWinVersion = (versionString, minVersion) => {\n    // The version string on Windows must have exactly three parts. The third part will\n    // be the version number, e. g. SEB_Windows_3.9.0.787.\n    const parts = versionString.split('_');\n    if (parts.length !== 3) {\n        return false;\n    }\n\n    return isVersionAtLeast(parts[2], minVersion);\n};\n\n/**\n * Compare two version strings (major.minor.patchlevel) and check whether the given\n * version is at least as recent as the reference version.\n *\n * @param {String} givenVersion given version to be compared\n * @param {String} minVersion minimum version to be compared with\n * @returns {boolean}\n */\nconst isVersionAtLeast = (givenVersion, minVersion) => {\n    const givenParts = givenVersion.split('.');\n    const expectedParts = minVersion.split('.');\n\n    // First, we compare the major version. If it is higher or lower,\n    // we do not need to check other parts.\n    if (parseInt(givenParts[0]) > parseInt(expectedParts[0])) {\n        return true;\n    }\n    if (parseInt(givenParts[0]) < parseInt(expectedParts[0])) {\n        return false;\n    }\n\n    // Then, we compare the minor version. Again, if it is higher or lower, we\n    // do not need to check the patchlevel.\n    if (parseInt(givenParts[1]) > parseInt(expectedParts[1])) {\n        return true;\n    }\n    if (parseInt(givenParts[1]) < parseInt(expectedParts[1])) {\n        return false;\n    }\n\n    // Finally, if there is a patchlevel, we compare it as well. On Mac, SEB might omit the\n    // .0 part, e. g. use '3.6' instead of '3.6.0'.\n    if (parseInt(givenParts[2] ?? '0') < parseInt(expectedParts[2] ?? '0')) {\n        return false;\n    }\n\n    return true;\n};\n\n/**\n * Add a modal overlay on top of the current page, actively blocking students from interacting\n * with the quiz' input fields and showing an information text.\n *\n * @param {String} targetVersion the target version the student would need to attempt the quiz,\n *                               empty if we could not determine the SEB variant (Mac / Windows)\n */\nconst addOverlay = async(targetVersion) => {\n    // We have two possible messages, one (the 'update' variant) telling the student they have to\n    // update their SEB to at least a given version and one (the 'invalid') variant telling them\n    // that the version could not be determined. This allows them to check the problem with their\n    // school, in case the version strings suddenly change our script is not able to correctly\n    // recognize them anymore.\n    const variant = (targetVersion === '' ? 'invalid' : 'update');\n\n    // Fetch the correct variant of the message, use our default texts as the fallback\n    // in case the text cannot be fetched.\n    let message = '';\n    try {\n        message = await String.get_string(\n            `overlay_text_${variant}`,\n            'quizaccess_sebversion',\n            {'version': targetVersion}\n        );\n    } catch (err) {\n        window.console.error(err);\n        message = DEFAULT_MESSAGES[variant] + targetVersion + '.';\n    }\n\n    // Create our modal overlay.\n    const overlay = document.createElement('div');\n    overlay.classList.add('quizaccess_sebversion_overlay');\n    overlay.setAttribute('role', 'alertdialog');\n    overlay.setAttribute('aria-modal', 'true');\n    overlay.tabIndex = 0;\n    overlay.textContent = message;\n\n    // Add our modal overlay to the DOM and make it the focused element.\n    document.querySelector('body').appendChild(overlay);\n    overlay.focus();\n\n    // Make sure that elements outside of the overlay cannot gain focus.\n    document.addEventListener('focus', (e) => {\n        if (!overlay.contains(e.target)) {\n            e.stopPropagation();\n            e.preventDefault();\n            overlay.focus();\n        }\n    }, true);\n\n    // Block all keyboard and pointer events from reaching the page.\n    const events = [\n        'keydown', 'keyup', 'keypress', 'input',\n        'mousedown', 'mouseup', 'click', 'dblclick',\n        'contextmenu',\n        'pointerdown', 'pointerup',\n        'touchstart', 'touchend',\n    ];\n    const blocker = (e) => {\n        e.stopPropagation();\n        e.preventDefault();\n    };\n    for (const e of events) {\n        document.addEventListener(e, blocker, true);\n    }\n};\n\n/**\n * This is a \"unit test\" for the isVersionAtLeast() function. It will run some test cases and\n * output a status message to the page. The message will then be caught by the behat test.\n */\nconst testisVersionAtLeast = () => {\n    // Test cases to be checked.\n    const cases = [\n        [true, ['1.2.3', '1.2.3']],\n        [true, ['2.0.0', '1.9.9']],\n        [true, ['2.0', '2.0.0']],\n        [true, ['2.0', '2.0']],\n        [true, ['2.0', '1.9.9']],\n        [false, ['1.0.0', '2.0.0']],\n        [true, ['1.5.0', '1.4.9']],\n        [false, ['1.3.0', '1.4.0']],\n        [true, ['1.2.5', '1.2.3']],\n        [false, ['1.2.1', '1.2.3']],\n        [true, ['1.2', '1.2.0']],\n        [false, ['1.2', '1.2.1']],\n        [true, ['1.2.1', '1.2']],\n        [true, ['1.2.0', '1.2']],\n        [true, ['10.12.3', '9.99.99']],\n        [false, ['10.1.3', '10.10.0']],\n    ];\n\n    // For easy detection in the Behat test, we will output some text to the web page.\n    const info = document.createElement('p');\n    info.textContent = 'quizaccess_sebversion unit tests successful';\n    for (let c of cases) {\n        let result = isVersionAtLeast(c[1][0], c[1][1]);\n        if (result !== c[0]) {\n            info.textContent = 'quizaccess_sebversion unit test failed';\n            window.console.error('failed unit test:', c);\n        }\n    }\n\n    document.body.append(info);\n};\n\nexport default {init};"],"names":["DEFAULT_MESSAGES","init","async","minVersionWin","minVersionMac","behat","testisVersionAtLeast","simulatedVersion","localStorage","getItem","window","SafeExamBrowser","versionString","_window$SafeExamBrows2","version","overlayNeeded","targetVersion","includes","checkMacVersion","checkWinVersion","addOverlay","minVersion","parts","split","length","isVersionAtLeast","givenVersion","givenParts","expectedParts","parseInt","variant","message","String","get_string","err","console","error","overlay","document","createElement","classList","add","setAttribute","tabIndex","textContent","querySelector","appendChild","focus","addEventListener","e","contains","target","stopPropagation","preventDefault","events","blocker","cases","info","c","body","append"],"mappings":"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"}