"use strict";(function(root,factory){if(typeof define==="function"&&define.amd){define("pdfjs-web/chromecom",["exports","pdfjs-web/app","pdfjs-web/overlay_manager","pdfjs-web/preferences","pdfjs-web/pdfjs"],factory)}else if(typeof exports!=="undefined"){factory(exports,require("./app.js"),require("./overlay_manager.js"),require("./preferences.js"),require("./pdfjs.js"))}else{factory(root.pdfjsWebChromeCom={},root.pdfjsWebApp,root.pdfjsWebOverlayManager,root.pdfjsWebPreferences,root.pdfjsWebPDFJS)}})(this,function(exports,app,overlayManager,preferences,pdfjsLib){var PDFViewerApplication=app.PDFViewerApplication;var DefaultExernalServices=app.DefaultExernalServices;var OverlayManager=overlayManager.OverlayManager;var Preferences=preferences.Preferences;var ChromeCom={};ChromeCom.request=function ChromeCom_request(action,data,callback){var message={action:action,data:data};if(!chrome.runtime){console.error("chrome.runtime is undefined.");if(callback){callback()}}else if(callback){chrome.runtime.sendMessage(message,callback)}else{chrome.runtime.sendMessage(message)}};ChromeCom.resolvePDFFile=function ChromeCom_resolvePDFFile(file,callback){file=file.replace(/^drive:/i,"filesystem:"+location.origin+"/external/");if(/^filesystem:/.test(file)&&!pdfjsLib.PDFJS.disableWorker){var resolveLocalFileSystemURL=window.resolveLocalFileSystemURL||window.webkitResolveLocalFileSystemURL;resolveLocalFileSystemURL(file,function onResolvedFSURL(fileEntry){fileEntry.file(function(fileObject){var blobUrl=URL.createObjectURL(fileObject);callback(blobUrl,fileObject.size)})},function onFileSystemError(error){console.warn("Cannot resolve file "+file+", "+error.name+" "+error.message);callback(file)});return}if(/^https?:/.test(file)){setReferer(file,function(){callback(file)});return}if(/^file?:/.test(file)){getEmbedderOrigin(function(origin){if(origin&&!/^file:|^chrome-extension:/.test(origin)){PDFViewerApplication.error("Blocked "+origin+" from loading "+file+". Refused to load a local file in a non-local page "+"for security reasons.");return}isAllowedFileSchemeAccess(function(isAllowedAccess){if(isAllowedAccess){callback(file)}else{requestAccessToLocalFile(file)}})});return}callback(file)};function getEmbedderOrigin(callback){var origin=window===top?location.origin:location.ancestorOrigins[0];if(origin==="null"){getParentOrigin(callback)}else{callback(origin)}}function getParentOrigin(callback){ChromeCom.request("getParentOrigin",null,callback)}function isAllowedFileSchemeAccess(callback){ChromeCom.request("isAllowedFileSchemeAccess",null,callback)}function isRuntimeAvailable(){try{if(chrome.runtime&&chrome.runtime.getManifest()){return true}}catch(e){}return false}function reloadIfRuntimeIsUnavailable(){if(!isRuntimeAvailable()){location.reload()}}var chromeFileAccessOverlayPromise;function requestAccessToLocalFile(fileUrl){var onCloseOverlay=null;if(top!==window){window.addEventListener("focus",reloadIfRuntimeIsUnavailable);onCloseOverlay=function(){window.removeEventListener("focus",reloadIfRuntimeIsUnavailable);reloadIfRuntimeIsUnavailable();OverlayManager.close("chromeFileAccessOverlay")}}if(!chromeFileAccessOverlayPromise){chromeFileAccessOverlayPromise=OverlayManager.register("chromeFileAccessOverlay",document.getElementById("chromeFileAccessOverlay"),onCloseOverlay,true)}chromeFileAccessOverlayPromise.then(function(){var iconPath=chrome.runtime.getManifest().icons[48];document.getElementById("chrome-pdfjs-logo-bg").style.backgroundImage="url("+chrome.runtime.getURL(iconPath)+")";var i18nFileAccessLabel=[chrome.i18n.getUILanguage&&chrome.i18n.getUILanguage()];if(i18nFileAccessLabel){document.getElementById("chrome-file-access-label").textContent=i18nFileAccessLabel}var link=document.getElementById("chrome-link-to-extensions-page");link.href="chrome://extensions/?id="+chrome.runtime.id;link.onclick=function(e){e.preventDefault();ChromeCom.request("openExtensionsPageForFileAccess",{newTab:e.ctrlKey||e.metaKey||e.button===1||window!==top})};document.getElementById("chrome-url-of-local-file").textContent=fileUrl;OverlayManager.open("chromeFileAccessOverlay")})}if(window===top){addEventListener("unload",function(){if(!isRuntimeAvailable()){localStorage.setItem("unload-"+Date.now()+"-"+document.hidden+"-"+location.href,JSON.stringify(history.state))}})}var port;function setReferer(url,callback){if(!port){port=chrome.runtime.connect({name:"chromecom-referrer"})}port.onDisconnect.addListener(onDisconnect);port.onMessage.addListener(onMessage);port.postMessage({referer:window.history.state&&window.history.state.chromecomState,requestUrl:url});function onMessage(referer){if(referer){var state=window.history.state||{};state.chromecomState=referer;window.history.replaceState(state,"")}onCompleted()}function onDisconnect(){port=null;callback()}function onCompleted(){port.onDisconnect.removeListener(onDisconnect);port.onMessage.removeListener(onMessage);callback()}}var storageArea=chrome.storage.sync||chrome.storage.local;Preferences._writeToStorage=function(prefObj){return new Promise(function(resolve){if(prefObj===Preferences.defaults){var keysToRemove=Object.keys(Preferences.defaults);storageArea.remove(keysToRemove,function(){resolve()})}else{storageArea.set(prefObj,function(){resolve()})}})};Preferences._readFromStorage=function(prefObj){return new Promise(function(resolve){if(chrome.storage.managed){chrome.storage.managed.get(Preferences.defaults,getPreferences)}else{getPreferences(Preferences.defaults)}function getPreferences(defaultPrefs){if(chrome.runtime.lastError){defaultPrefs=Preferences.defaults}storageArea.get(defaultPrefs,function(readPrefs){resolve(readPrefs)})}})};var ChromeExternalServices=Object.create(DefaultExernalServices);ChromeExternalServices.initPassiveLoading=function(callbacks){ChromeCom.resolvePDFFile(DEFAULT_URL,function(url,length,originalURL){callbacks.onOpenWithURL(url,length,originalURL)})};PDFViewerApplication.externalServices=ChromeExternalServices;exports.ChromeCom=ChromeCom});